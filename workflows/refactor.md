## Refactor - 重构工作流

### 描述
安全地重构代码，通过分析、小步重构和持续验证确保功能不变。

### 触发条件
- 代码需要优化
- 技术债务需要清理
- 架构需要调整

### 前置条件 (preconditions)

```yaml
checks:
  - name: tests_exist
    description: 有可运行的测试
    weight: 25
  - name: tests_passing
    description: 所有测试通过
    weight: 25
  - name: code_understood
    description: 代码逻辑已理解
    weight: 15
  - name: backup_available
    description: 有代码备份或版本控制
    weight: 15

threshold: 50

destructive:
  - modify_code: true
```

### 执行配置
- **模式**: strict
- **偏差处理**: block

### 步骤

#### Step 1: 分析现状

- **关键**: true
- **依赖**: []
- **Agent**: analyzer
- **并行**: false
- **输出**: 代码分析报告
- **验收**: 识别所有重构点

**任务**: 分析目标代码，识别重构机会和风险点。

**分析内容**:
- 代码复杂度
- 重复代码
- 设计模式应用
- 依赖关系
- 潜在风险

**分析目标文件**，识别代码质量问题和重构机会

---

#### Step 2: 设计重构方案

- **关键**: true
- **依赖**: [1]
- **Agent**: designer
- **并行**: false
- **输出**: 重构计划
- **验收**: 重构步骤可执行

**任务**: 创建重构计划，定义小步重构步骤。

**重构原则**:
- 小步前进
- 频繁验证
- 保持测试通过
- 随时可回滚

**输出格式**:
```yaml
重构步骤:
  - Step 1: [小改动] (验证: [测试])
  - Step 2: [小改动] (验证: [测试])
  ...
```

---

#### Step 3: 创建测试基线 (如需要)

- **关键**: true
- **依赖**: [2]
- **Agent**: tester
- **并行**: false
- **输出**: 测试覆盖
- **验收**: 新测试通过

**任务**: 如果现有测试不足，先创建测试保护。

**条件**: 测试覆盖率 < 80% 时执行

**测试类型**:
- 单元测试
- 集成测试
- 快照测试

---

#### Step 4: 小步重构 (循环)

- **关键**: true
- **依赖**: [3]
- **Agent**: implementer
- **并行**: false
- **输出**: 重构后的代码
- **验收**: 每步测试通过

**任务**: 按重构计划执行小步重构。

**循环流程**:
```yaml
for each refactoring_step:
  1. 执行代码改动
  2. 运行测试
  3. 测试通过? 继续 : 回滚
  4. 提交改动
```

**每次改动**:
- 单一职责
- 可独立验证
- 不影响功能

---

#### Step 5: 验证结果

- **关键**: true
- **依赖**: [4]
- **Agent**: verifier
- **并行**: false
- **输出**: 验证报告
- **验收**: 功能一致，质量提升

**任务**: 全面验证重构结果。

**验证项**:
- [ ] 所有测试通过
- [ ] 功能行为一致
- [ ] 性能无退化
- [ ] 代码质量提升
- [ ] 文档已更新

---

#### Step 6: 更新文档

- **关键**: false
- **依赖**: [5]
- **Agent**: documenter
- **并行**: false
- **输出**: 更新的文档
- **验收**: 文档与代码一致

**任务**: 更新相关文档以反映重构变化。

**文档类型**:
- 代码注释
- API 文档
- 架构文档
- README

---

## 示例使用场景

```yaml
场景: 重构用户认证模块

Step 1: 分析
  → 发现代码重复
  → 复杂度过高
  → 缺少抽象

Step 2: 设计
  → 提取认证服务
  → 统一错误处理
  → 添加接口抽象

Step 3: 测试基线
  → 添加集成测试
  → 确保覆盖现有行为

Step 4: 小步重构
  → 1. 提取接口
  → 2. 迁移一个实现
  → 3. 验证测试
  → 4. 重复 2-3

Step 5: 验证
  → 所有测试通过
  → 功能行为一致
  → 代码质量提升

Step 6: 文档
  → 更新架构文档
```
